library(lavaan)
setwd("/Users/sulailfatima/Desktop/Megasync/transgenderdata")
tg.data <- read.spss("Data_transgenderBSSImodification_dataUpdated.sav",
                     to.data.frame = T,
                     use.value.labels = TRUE,
                     trim.factor.names = F,
                     trim_values = F)
## Standardized variables
## BSSI
ave.bssi <- mean(tg.data$BSSIScore2)
sd.bssi <- sd(tg.data$BSSIScore2)
tg.data$stdbssi <- ((tg.data$BSSIScore2 - ave.bssi)/sd.bssi)
## SC
ave.sc <- mean(tg.data$SCTotalScore)
sd.sc <- sd(tg.data$SCTotalScore)
tg.data$stdsc <- ((tg.data$SCTotalScore - ave.sc)/sd.sc)
## AKUADS
ave.akuads <- mean(tg.data$AKUADSScore2)
sd.akuads <- sd(tg.data$AKUADSScore2)
tg.data$stdakuads <- ((tg.data$AKUADSScore2 - ave.akuads)/sd.akuads)

tg.model <- ' # direct effect
             stdbssi ~ c*stdsc
              # mediator
             stdakuads ~ a*stdsc
             stdbssi ~ b*stdakuads
              # indirect effect (a*b)
             ab := a*b
              # total effect
             total := c + (a*b)
         '
tg.fit <- sem(tg.model, data = tg.data, se = 'bootstrap', bootstrap = 500)
summary(tg.fit,
        fit.measures = T,
        standardize = T,
        ci = T)
####
# Identifying if a group has effect modification on mediation 
tg.model1 <- ' # direct effect
                stdbssi ~ c(cg1, cg2)*stdsc
                # mediator
                stdakuads ~ c(ag1, ag2)*stdsc
                stdsc ~ c(bg1, bg2)*stdakuads
                # indirect effect (a*b)
                abg1 := ag1*bg1
                abg2 := ag1*bg2
                # total effect
                totalg1 := cg1 + (ag1*bg1)
                totalg2 := cg2 + (ag2*bg2)  
'
tg.fit1 <- sem(tg.model1,
               group = "SocCap39a",
               data = tg.data, 
               se = 'bootstrap',
               bootstrap = 500)
summary(tg.fit1, fit.measures=T, standardized=T, ci=TRUE)
#Define object similarly to a normal lavaan model, but just telling Lavaan these are the constraints we are interested in testing simultaneously. 

all.constraints<- 'ag1 == ag2
                  bg1 == bg2
                  cg1 == cg2'
lavTestWald(tg.fit1, all.constraints ) # p-val 8.508748e-08

# Language (SocCap43a) moderates the mediation effect of AKUADS, now to 
# determine which paths in particular differ between group 1 & 2
lavTestWald(tg.fit1, constraints = "ag1==ag2") # p-val 0.02664268

lavTestWald(tg.fit1, constraints = "bg1==bg2") # p-val 0.003565169

lavTestWald(tg.fit1, constraints = "cg1==cg2") # p-val 0.8862305 









